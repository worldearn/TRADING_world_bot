<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TRADING_world_bot</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1,h2,h3,p,label {
    margin: 0 0 10px 0;
  }
  button {
    cursor: pointer;
  }
  /* Container */
  #container {
    width: 100%;
    max-width: 700px;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 20px 30px;
    margin: 20px;
  }
  /* Login/signup */
  #login-section, #signup-section {
    max-width: 400px;
    margin: auto;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }
  button {
    background: #4caf50;
    border: none;
    padding: 12px;
    color: white;
    font-weight: 700;
    border-radius: 10px;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #3a8d38;
  }
  .link {
    color: #99caff;
    cursor: pointer;
    text-align: center;
    margin-top: 10px;
    user-select: none;
  }
  .error {
    color: #ff7979;
    margin-bottom: 15px;
    font-weight: 600;
  }

  /* Dashboards */
  #user-dashboard, #agent-dashboard {
    display: none;
    max-width: 700px;
    background: rgba(255 255 255 / 0.1);
    padding: 20px 30px;
    border-radius: 12px;
    margin-top: 20px;
  }
  header.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  header.dashboard-header h2 {
    margin: 0;
  }
  header.dashboard-header button {
    background: #e74c3c;
    padding: 8px 15px;
    font-weight: 700;
    border-radius: 8px;
  }
  header.dashboard-header button:hover {
    background: #c0392b;
  }

  /* User Dashboard Tabs */
  nav.user-nav {
    display: flex;
    justify-content: space-around;
    margin-bottom: 15px;
  }
  nav.user-nav button {
    background: #5a8dee;
    border-radius: 12px;
    padding: 10px 15px;
    font-weight: 700;
    flex: 1;
    margin: 0 5px;
    transition: background 0.3s ease;
  }
  nav.user-nav button.active, nav.user-nav button:hover {
    background: #3b6bcc;
  }

  /* Sections */
  section {
    display: none;
  }
  section.active {
    display: block;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255 255 255 / 0.15);
    border-radius: 8px;
    overflow: hidden;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
  }
  th {
    background: #5a8dee;
  }
  tr:last-child td {
    border-bottom: none;
  }

  /* VIP Cards */
  .vip-cards {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .vip-card {
    background: rgba(255 255 255 / 0.1);
    border-radius: 12px;
    padding: 20px;
    width: 200px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    text-align: center;
    transition: transform 0.3s ease;
  }
  .vip-card:hover {
    transform: scale(1.05);
    box-shadow: 0 0 25px rgba(255,255,255,0.5);
  }
  .vip-card h4 {
    margin-bottom: 10px;
    font-size: 1.2rem;
  }
  .vip-card p {
    font-weight: 700;
    font-size: 1.5rem;
    margin-bottom: 15px;
  }
  .vip-card ul {
    list-style: none;
    padding: 0;
    margin-bottom: 15px;
    font-size: 0.9rem;
    text-align: left;
  }
  .vip-card ul li {
    margin-bottom: 8px;
  }
  .vip-card button {
    background-color: #4caf50;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 600;
  }
  .vip-card button:hover {
    background-color: #388e3c;
  }

  /* Responsive */
  @media (max-width: 700px) {
    nav.user-nav {
      flex-direction: column;
    }
    nav.user-nav button {
      margin: 5px 0;
    }
    .vip-cards {
      flex-direction: column;
      align-items: center;
    }
    .vip-card {
      width: 100%;
      max-width: 300px;
    }
  }

  /* About Section */
  #about {
    padding: 20px;
    background: rgba(255 255 255 / 0.1);
    border-radius: 12px;
    max-width: 700px;
    margin: 20px auto;
    color: #fff;
  }
</style>
</head>
<body>

<div id="container">

  <!-- LOGIN -->
  <div id="login-section">
    <h2>Login</h2>
    <div id="login-error" class="error"></div>
    <label for="login-id">User ID</label>
    <input type="text" id="login-id" placeholder="Enter your User ID" autocomplete="off" />
    <label for="login-password">Password</label>
    <input type="password" id="login-password" placeholder="Enter your password" autocomplete="off" />
    <button id="login-btn">Login</button>
    <div class="link" id="show-signup">New user? Click here to Sign Up</div>
  </div>

  <!-- SIGNUP -->
  <div id="signup-section" style="display:none;">
    <h2>Sign Up (User Only)</h2>
    <div id="signup-error" class="error"></div>
    <label for="signup-id">User ID</label>
    <input type="text" id="signup-id" placeholder="Create your User ID" autocomplete="off" />
    <label for="signup-password">Password</label>
    <input type="password" id="signup-password" placeholder="Create your password" autocomplete="off" />
    <button id="signup-btn">Sign Up</button>
    <div class="link" id="show-login">Go back to Login</div>
  </div>

  <!-- USER DASHBOARD -->
  <div id="user-dashboard">
    <header class="dashboard-header">
      <h2>User Dashboard</h2>
      <button id="logout-user">Logout</button>
    </header>

    <nav class="user-nav">
      <button class="tab-btn active" data-section="overview">Overview</button>
      <button class="tab-btn" data-section="vip">VIP Package</button>
      <button class="tab-btn" data-section="withdraw">Withdrawal Request</button>
      <button class="tab-btn" data-section="portfolio">Portfolio</button>
      <button class="tab-btn" data-section="about">About Us</button>
      <button class="tab-btn" data-section="profile">Profile</button>
    </nav>

    <section id="overview" class="active">
      <p><strong>Balance:</strong> <span id="user-balance">0.00</span> USDT</p>
      <p><strong>Daily Earnings (7% base + VIP bonus):</strong> <span id="user-daily-earning">0.00</span> USDT</p>
      <p><strong>VIP Level:</strong> <span id="user-vip-level">0</span></p>
      <button id="deposit-btn" style="background:#1abc9c; margin-top:15px;">Deposit Request (Open Telegram Bot)</button>
    </section>

    <section id="vip">
      <h3>Buy VIP Packages</h3>
      <div class="vip-cards">
        <div class="vip-card">
          <h4>VIP Basic</h4>
          <p>100 USDT</p>
          <ul>
            <li>7% Daily Return</li>
            <li>Standard Support</li>
          </ul>
          <button onclick="buyVip(100)">Buy</button>
        </div>
        <div class="vip-card">
          <h4>VIP Silver</h4>
          <p>500 USDT</p>
          <ul>
            <li>8.5% Daily Return</li>
            <li>Priority Support</li>
            <li>Special Trading Tips</li>
          </ul>
          <button onclick="buyVip(500)">Buy</button>
        </div>
        <div class="vip-card">
          <h4>VIP Gold</h4>
          <p>1000 USDT</p>
          <ul>
            <li>10% Daily Return</li>
            <li>24/7 Premium Support</li>
            <li>Exclusive BTC Trading Insights</li>
          </ul>
          <button onclick="buyVip(1000)">Buy</button>
        </div>
      </div>
    </section>

    <section id="withdraw">
      <h3>Request Withdrawal</h3>
      <label for="withdraw-amount">Amount</label>
      <input type="number" id="withdraw-amount" min="1" placeholder="Enter amount" />
      <button id="withdraw-request-btn">Request Withdraw</button>
      <div id="withdraw-msg" class="error" style="margin-top:10px;"></div>
    </section>

    <section id="portfolio">
      <h3>Your Portfolio</h3>
      <p>VIP Packages Bought: <span id="vip-packages-count">0</span></p>
      <p>Total Withdraw Requests: <span id="total-withdraw-requests">0</span></p>
    </section>

    <section id="about">
      <h2>About Our Company</h2>
      <p>
        At <strong>World Earning System</strong>, we specialize in cryptocurrency trading, particularly <strong>Bitcoin (BTC) trading</strong>. Our experience provides you with safe, fast, and reliable investment opportunities.
      </p>
      <p>
        Our team works on market analysis, modern trading strategies, and risk management to help your capital grow consistently.
      </p>
      <p>
        We are committed to supporting your success in BTC trading with excellent VIP plans and personalized assistance.
      </p>
    </section>

    <section id="profile">
      <h2>Your Profile</h2>
      <p><strong>User ID:</strong> <span id="profile-id"></span></p>
      <p><strong>Balance:</strong> <span id="profile-balance"></span> USDT</p>
      <p><strong>VIP Level:</strong> <span id="profile-vip"></span></p>
      <p><strong>Estimated Daily Interest Rate:</strong> <span id="profile-interest-rate"></span>%</p>
    </section>
  </div>

  <!-- AGENT DASHBOARD -->
  <div id="agent-dashboard">
    <header class="dashboard-header">
      <h2>Agent Dashboard</h2>
      <button id="logout-agent">Logout</button>
    </header>

    <label for="agent-search-id">Search User ID</label>
    <input type="text" id="agent-search-id" placeholder="Enter User ID" autocomplete="off" />
    <button id="agent-search-btn">Search</button>

    <div id="agent-user-details" style="margin-top:15px; display:none;">
      <h3>User Details</h3>
      <p><strong>ID:</strong> <span id="agent-user-id"></span></p>
      <p><strong>Balance:</strong> <span id="agent-user-balance"></span> USDT</p>
      <p><strong>VIP Level:</strong> <span id="agent-user-vip"></span></p>
      <p><strong>Daily Earnings:</strong> <span id="agent-user-daily"></span> USDT</p>

      <h4>Deposit/Withdraw Actions</h4>
      <label for="agent-deposit-amount">Deposit Amount</label>
      <input type="number" id="agent-deposit-amount" min="1" placeholder="Enter Deposit Amount" />
      <button id="agent-deposit-btn">Make Deposit</button>

      <label for="agent-withdraw-amount">Withdraw Amount</label>
      <input type="number" id="agent-withdraw-amount" min="1" placeholder="Enter Withdraw Amount" />
      <button id="agent-withdraw-btn">Approve Withdraw</button>
    </div>

    <div style="margin-top:20px;">
      <h3>Withdrawal Requests</h3>
      <table>
        <thead>
          <tr>
            <th>User ID</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Approve</th>
          </tr>
        </thead>
        <tbody id="withdraw-requests-tbody">
          <!-- Withdraw requests listed here -->
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
(() => {
  // Fixed Agents with passwords
  const agents = {
    'agent001': 'Nabin@1234',
    'agent002': 'Rolex@4567',
    'agent003': 'Agent007pass'
  };

  // Helper functions for localStorage users
  const loadUsers = () => {
    const u = localStorage.getItem('users');
    return u ? JSON.parse(u) : {};
  };
  const saveUsers = (users) => {
    localStorage.setItem('users', JSON.stringify(users));
  };

  // Withdrawal requests saved in localStorage
  const loadWithdrawRequests = () => {
    const w = localStorage.getItem('withdrawRequests');
    return w ? JSON.parse(w) : [];
  };
  const saveWithdrawRequests = (requests) => {
    localStorage.setItem('withdrawRequests', JSON.stringify(requests));
  };

  // Current logged in user or agent info
  let currentUserId = null;
  let currentAgentId = null;

  // Elements
  const loginSection = document.getElementById('login-section');
  const signupSection = document.getElementById('signup-section');
  const userDashboard = document.getElementById('user-dashboard');
  const agentDashboard = document.getElementById('agent-dashboard');
  const loginIdInput = document.getElementById('login-id');
  const loginPasswordInput = document.getElementById('login-password');
  const loginBtn = document.getElementById('login-btn');
  const loginErrorDiv = document.getElementById('login-error');
  const signupIdInput = document.getElementById('signup-id');
  const signupPasswordInput = document.getElementById('signup-password');
  const signupBtn = document.getElementById('signup-btn');
  const signupErrorDiv = document.getElementById('signup-error');
  const showSignupLink = document.getElementById('show-signup');
  const showLoginLink = document.getElementById('show-login');

  // User dashboard elements
  const logoutUserBtn = document.getElementById('logout-user');
  const userBalanceSpan = document.getElementById('user-balance');
  const userDailyEarningSpan = document.getElementById('user-daily-earning');
  const userVipLevelSpan = document.getElementById('user-vip-level');
  const depositBtn = document.getElementById('deposit-btn');

  // VIP buy buttons use buyVip function (global)

  // User dashboard tabs
  const userTabs = document.querySelectorAll('nav.user-nav button.tab-btn');
  const sections = document.querySelectorAll('#user-dashboard section');

  // Withdrawal elements
  const withdrawAmountInput = document.getElementById('withdraw-amount');
  const withdrawRequestBtn = document.getElementById('withdraw-request-btn');
  const withdrawMsgDiv = document.getElementById('withdraw-msg');

  // Portfolio
  const vipPackagesCountSpan = document.getElementById('vip-packages-count');
  const totalWithdrawRequestsSpan = document.getElementById('total-withdraw-requests');

  // Profile
  const profileIdSpan = document.getElementById('profile-id');
  const profileBalanceSpan = document.getElementById('profile-balance');
  const profileVipSpan = document.getElementById('profile-vip');
  const profileInterestRateSpan = document.getElementById('profile-interest-rate');

  // Agent dashboard elements
  const logoutAgentBtn = document.getElementById('logout-agent');
  const agentSearchIdInput = document.getElementById('agent-search-id');
  const agentSearchBtn = document.getElementById('agent-search-btn');
  const agentUserDetailsDiv = document.getElementById('agent-user-details');
  const agentUserIdSpan = document.getElementById('agent-user-id');
  const agentUserBalanceSpan = document.getElementById('agent-user-balance');
  const agentUserVipSpan = document.getElementById('agent-user-vip');
  const agentUserDailySpan = document.getElementById('agent-user-daily');
  const agentDepositAmountInput = document.getElementById('agent-deposit-amount');
  const agentDepositBtn = document.getElementById('agent-deposit-btn');
  const agentWithdrawAmountInput = document.getElementById('agent-withdraw-amount');
  const agentWithdrawBtn = document.getElementById('agent-withdraw-btn');
  const withdrawRequestsTbody = document.getElementById('withdraw-requests-tbody');

  // --- Utils ---

  // VIP Packages Data
  const vipPackages = [
    { name: 'VIP Basic', price: 100, dailyReturn: 7 },
    { name: 'VIP Silver', price: 500, dailyReturn: 8.5 },
    { name: 'VIP Gold', price: 1000, dailyReturn: 10 }
  ];

  // Calculate user's daily earning based on balance and VIP level (which decides rate)
  function calculateDailyEarning(user) {
    if (!user) return 0;
    // Base 7% daily + VIP bonus based on VIP package
    let baseRate = 7;
    if (user.vipPackage) {
      const pkg = vipPackages.find(p => p.price === user.vipPackage.price);
      if (pkg) {
        baseRate = pkg.dailyReturn;
      }
    }
    return (user.balance * baseRate) / 100;
  }

  // Get VIP package by price
  function getVipPackageByPrice(price) {
    return vipPackages.find(p => p.price === price);
  }

  // --- AUTH ---

  function showLogin() {
    loginSection.style.display = 'block';
    signupSection.style.display = 'none';
    userDashboard.style.display = 'none';
    agentDashboard.style.display = 'none';
    loginErrorDiv.textContent = '';
    signupErrorDiv.textContent = '';
  }

  function showSignup() {
    loginSection.style.display = 'none';
    signupSection.style.display = 'block';
    userDashboard.style.display = 'none';
    agentDashboard.style.display = 'none';
    loginErrorDiv.textContent = '';
    signupErrorDiv.textContent = '';
  }

  // Signup user (simple)
  signupBtn.onclick = () => {
    const id = signupIdInput.value.trim();
    const password = signupPasswordInput.value.trim();
    if (!id || !password) {
      signupErrorDiv.textContent = 'User ID and password are required.';
      return;
    }
    const users = loadUsers();
    if (users[id]) {
      signupErrorDiv.textContent = 'User ID already exists.';
      return;
    }
    users[id] = {
      password,
      balance: 0,
      vipLevel: 0,
      vipPackage: null,
      withdrawRequests: [],
      vip: 0 // numeric vip level for convenience
    };
    saveUsers(users);
    alert('Signup successful! Please login.');
    showLogin();
  };

  // Login handler (user or agent)
  loginBtn.onclick = () => {
    const id = loginIdInput.value.trim();
    const password = loginPasswordInput.value.trim();
    if (!id || !password) {
      loginErrorDiv.textContent = 'Please enter both User ID and password.';
      return;
    }

    // Check if agent login
    if (agents[id] && agents[id] === password) {
      currentAgentId = id;
      currentUserId = null;
      loginSection.style.display = 'none';
      signupSection.style.display = 'none';
      agentDashboard.style.display = 'block';
      userDashboard.style.display = 'none';
      loginErrorDiv.textContent = '';
      loadWithdrawRequestsToAgentTable();
      clearAgentUserDetails();
      return;
    }

    // User login
    const users = loadUsers();
    if (!users[id] || users[id].password !== password) {
      loginErrorDiv.textContent = 'Invalid User ID or password.';
      return;
    }

    currentUserId = id;
    currentAgentId = null;
    loginSection.style.display = 'none';
    signupSection.style.display = 'none';
    userDashboard.style.display = 'block';
    agentDashboard.style.display = 'none';
    loginErrorDiv.textContent = '';
    updateUserDashboard();
  };

  // Logout buttons
  logoutUserBtn.onclick = () => {
    currentUserId = null;
    showLogin();
  };
  logoutAgentBtn.onclick = () => {
    currentAgentId = null;
    showLogin();
  };

  // Show signup/login toggle links
  showSignupLink.onclick = () => showSignup();
  showLoginLink.onclick = () => showLogin();

  // --- USER DASHBOARD ---

  // Tabs switching
  userTabs.forEach(btn => {
    btn.addEventListener('click', () => {
      userTabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const secId = btn.getAttribute('data-section');
      sections.forEach(s => s.classList.remove('active'));
      const activeSection = document.getElementById(secId);
      if (activeSection) activeSection.classList.add('active');
    });
  });

  // Update user dashboard info
  function updateUserDashboard() {
    const users = loadUsers();
    const user = users[currentUserId];
    if (!user) return;

    // Show user info
    userBalanceSpan.textContent = user.balance.toFixed(2);
    userVipLevelSpan.textContent = user.vipPackage ? user.vipPackage.name : 'None';
    const dailyEarning = calculateDailyEarning(user);
    userDailyEarningSpan.textContent = dailyEarning.toFixed(2);

    // Profile section
    profileIdSpan.textContent = currentUserId;
    profileBalanceSpan.textContent = user.balance.toFixed(2);
    profileVipSpan.textContent = user.vipPackage ? user.vipPackage.name : 'None';
    profileInterestRateSpan.textContent = user.vipPackage ? user.vipPackage.dailyReturn : '7';

    // Portfolio counts
    vipPackagesCountSpan.textContent = user.vipPackage ? '1' : '0';
    const requests = loadWithdrawRequests().filter(r => r.userId === currentUserId);
    totalWithdrawRequestsSpan.textContent = requests.length;
  }

  // Deposit button (user side)
  depositBtn.onclick = () => {
    // Open telegram bot link
    window.open('https://t.me/CostumereCare_Bot', '_blank');
  };

  // Buy VIP package
  window.buyVip = function(price) {
    const users = loadUsers();
    const user = users[currentUserId];
    if (!user) {
      alert('User not logged in.');
      return;
    }
    if (user.balance < price) {
      alert('Insufficient balance to buy this VIP package.');
      return;
    }
    // Deduct balance
    user.balance -= price;
    // Assign VIP package
    user.vipPackage = getVipPackageByPrice(price);
    saveUsers(users);
    alert(`Congratulations! You bought the ${user.vipPackage.name} package.`);
    updateUserDashboard();
  };

  // Withdrawal request
  withdrawRequestBtn.onclick = () => {
    const amount = parseFloat(withdrawAmountInput.value);
    withdrawMsgDiv.textContent = '';
    if (!amount || amount <= 0) {
      withdrawMsgDiv.textContent = 'Please enter a valid amount.';
      return;
    }
    const users = loadUsers();
    const user = users[currentUserId];
    if (!user) {
      withdrawMsgDiv.textContent = 'User not logged in.';
      return;
    }
    if (amount > user.balance) {
      withdrawMsgDiv.textContent = 'Insufficient balance.';
      return;
    }
    // Add withdrawal request
    let withdrawRequests = loadWithdrawRequests();
    withdrawRequests.push({
      id: Date.now(),
      userId: currentUserId,
      amount,
      status: 'pending'
    });
    saveWithdrawRequests(withdrawRequests);
    alert('Withdrawal request submitted.');
    withdrawAmountInput.value = '';
  };

  // --- AGENT DASHBOARD ---

  // Clear agent user detail display
  function clearAgentUserDetails() {
    agentUserDetailsDiv.style.display = 'none';
    agentUserIdSpan.textContent = '';
    agentUserBalanceSpan.textContent = '';
    agentUserVipSpan.textContent = '';
    agentUserDailySpan.textContent = '';
    agentDepositAmountInput.value = '';
    agentWithdrawAmountInput.value = '';
  }

  // Search user by ID in agent dashboard
  agentSearchBtn.onclick = () => {
    const id = agentSearchIdInput.value.trim();
    const users = loadUsers();
    if (!users[id]) {
      alert('User not found');
      clearAgentUserDetails();
      return;
    }
    const user = users[id];
    agentUserIdSpan.textContent = id;
    agentUserBalanceSpan.textContent = user.balance.toFixed(2);
    agentUserVipSpan.textContent = user.vipPackage ? user.vipPackage.name : 'None';
    agentUserDailySpan.textContent = calculateDailyEarning(user).toFixed(2);
    agentUserDetailsDiv.style.display = 'block';
  };

  // Agent Deposit
  agentDepositBtn.onclick = () => {
    const amount = parseFloat(agentDepositAmountInput.value);
    if (!amount || amount <= 0) {
      alert('Enter valid deposit amount');
      return;
    }
    const id = agentUserIdSpan.textContent;
    if (!id) {
      alert('Search and select user first');
      return;
    }
    const users = loadUsers();
    if (!users[id]) {
      alert('User not found');
      return;
    }
    users[id].balance += amount;

    // Optional: Auto upgrade VIP level by balance thresholds
    // For example: balance >= 1000 => Gold, >= 500 => Silver, >= 100 => Basic
    if (users[id].balance >= 1000) {
      users[id].vipPackage = getVipPackageByPrice(1000);
    } else if (users[id].balance >= 500) {
      users[id].vipPackage = getVipPackageByPrice(500);
    } else if (users[id].balance >= 100) {
      users[id].vipPackage = getVipPackageByPrice(100);
    } else {
      users[id].vipPackage = null;
    }

    saveUsers(users);
    alert(`Deposited ${amount.toFixed(2)} USDT to ${id}.`);
    agentUserBalanceSpan.textContent = users[id].balance.toFixed(2);
    agentUserVipSpan.textContent = users[id].vipPackage ? users[id].vipPackage.name : 'None';
    agentUserDailySpan.textContent = calculateDailyEarning(users[id]).toFixed(2);
    agentDepositAmountInput.value = '';
  };

  // Agent Withdraw Approve
  agentWithdrawBtn.onclick = () => {
    const amount = parseFloat(agentWithdrawAmountInput.value);
    if (!amount || amount <= 0) {
      alert('Enter valid withdraw amount');
      return;
    }
    const id = agentUserIdSpan.textContent;
    if (!id) {
      alert('Search and select user first');
      return;
    }
    const users = loadUsers();
    if (!users[id]) {
      alert('User not found');
      return;
    }
    if (users[id].balance < amount) {
      alert('User balance insufficient');
      return;
    }

    // Deduct balance
    users[id].balance -= amount;

    // Remove any withdrawal requests of this user and amount (simplify)
    let withdrawRequests = loadWithdrawRequests();
    withdrawRequests = withdrawRequests.map(r => {
      if (r.userId === id && r.amount === amount && r.status === 'pending') {
        r.status = 'approved';
      }
      return r;
    });
    saveWithdrawRequests(withdrawRequests);
    saveUsers(users);

    alert(`Withdraw approved: ${amount.toFixed(2)} USDT from ${id}.`);
    agentUserBalanceSpan.textContent = users[id].balance.toFixed(2);
    agentUserVipSpan.textContent = users[id].vipPackage ? users[id].vipPackage.name : 'None';
    agentUserDailySpan.textContent = calculateDailyEarning(users[id]).toFixed(2);
    agentWithdrawAmountInput.value = '';
    loadWithdrawRequestsToAgentTable();
  };

  // Load withdraw requests to agent table
  function loadWithdrawRequestsToAgentTable() {
    const withdrawRequests = loadWithdrawRequests();
    withdrawRequestsTbody.innerHTML = '';
    withdrawRequests.forEach(req => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${req.userId}</td>
        <td>${req.amount.toFixed(2)}</td>
        <td>${req.status}</td>
        <td>
          ${req.status === 'pending' ? `<button data-id="${req.id}" class="approve-btn">Approve</button>` : ''}
        </td>
      `;
      withdrawRequestsTbody.appendChild(tr);
    });

    // Attach approve button handlers
    document.querySelectorAll('.approve-btn').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-id');
        approveWithdrawRequest(id);
      };
    });
  }

  // Approve withdrawal request by agent
  function approveWithdrawRequest(id) {
    let withdrawRequests = loadWithdrawRequests();
    const request = withdrawRequests.find(r => r.id == id);
    if (!request) {
      alert('Request not found');
      return;
    }
    if (request.status !== 'pending') {
      alert('Request already processed');
      return;
    }
    const users = loadUsers();
    const user = users[request.userId];
    if (!user) {
      alert('User not found');
      return;
    }
    if (user.balance < request.amount) {
      alert('User balance insufficient');
      return;
    }

    user.balance -= request.amount;
    request.status = 'approved';

    saveUsers(users);
    saveWithdrawRequests(withdrawRequests);

    alert(`Withdrawal of ${request.amount.toFixed(2)} USDT approved for user ${request.userId}.`);
    if (agentUserIdSpan.textContent === request.userId) {
      agentUserBalanceSpan.textContent = user.balance.toFixed(2);
      agentUserVipSpan.textContent = user.vipPackage ? user.vipPackage.name : 'None';
      agentUserDailySpan.textContent = calculateDailyEarning(user).toFixed(2);
    }
    loadWithdrawRequestsToAgentTable();
  }

  // Initialize with login screen
  showLogin();

})();
</script>
</body>
</html>
